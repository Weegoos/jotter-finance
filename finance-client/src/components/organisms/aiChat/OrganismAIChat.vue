<template>
  <main class="flex-1 flex justify-center px-6 py-4">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-md flex flex-col">
      <!-- System screen -->
      <div v-if="props.isSystem" class="p-10 flex justify-center">
        <div class="max-w-md text-center">
          <div
            class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 max-w-md text-center animate-fadeIn"
          >
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Jotter Finance</h1>
            <h2 class="text-lg text-gray-600 mb-4">powered by pAIda ü§ñ</h2>
            <p class="text-gray-600 mb-4">
              –ü—Ä–∏–≤–µ—Ç! üëã –Ø pAIda ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.
            </p>
            <div class="text-left text-gray-500 text-sm space-y-1">
              <p>–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å:</p>
              <ul class="list-none pl-2 space-y-1">
                <li>üìä –ê–Ω–∞–ª–∏–∑–æ–º —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –¥–æ—Ö–æ–¥–æ–≤</li>
                <li>üí∞ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±—é–¥–∂–µ—Ç–∞</li>
                <li>üéØ –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π</li>
                <li>üìà –û—Å–Ω–æ–≤–∞–º–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                <li>üí° –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏</li>
              </ul>
            </div>
            <p class="text-gray-600 mt-4 font-medium">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?</p>
          </div>
        </div>
        <div
          v-if="!props.isVisibleChatID"
          class="mt-6 bg-gray-50 border border-gray-200 rounded-xl p-4 text-gray-700 text-sm space-y-2"
        >
          <p>
            üí° –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≤–∞–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å
            —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏:
          </p>
          <ol class="list-decimal list-inside space-y-1">
            <li>
              üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–≤–æ–∏ –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã: –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∏—â–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
              –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.
            </li>
            <li>
              üí∞ –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –±—é–¥–∂–µ—Ç: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –ª–∏–º–∏—Ç—ã –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –∏—Ö
              –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º.
            </li>
            <li>
              üéØ –°—Ç–∞–≤—å—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏: –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∫–æ–ø–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ñ–æ–Ω–¥, –∫—É–ø–∏—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∏–ª–∏
              –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.
            </li>
            <li>
              üìà –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å —É–º–æ–º: –∏–∑—É—á–∞–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ –∞–∫—Ç–∏–≤—ã,
              –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∏—Å–∫–∏.
            </li>
            <li>
              üí° –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: –∏—â–∏—Ç–µ –≤—ã–≥–æ–¥–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã, –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Å–∫–∏–¥–∫–∏, —á—Ç–æ–±—ã
              –±–æ–ª—å—à–µ —Å–±–µ—Ä–µ–≥–∞—Ç—å.
            </li>
            <li>
              üå± –†–∞–∑–≤–∏–≤–∞–π—Ç–µ—Å—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ: —á–∏—Ç–∞–π—Ç–µ –∫–Ω–∏–≥–∏, –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –∫—É—Ä—Å—ã –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏
              —ç–∫–æ–Ω–æ–º–∏–∫–∏.
            </li>
            <li>
              üìù –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å: –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç–µ—Å—å –∫ —Ü–µ–ª—è–º,
              –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
            </li>
          </ol>
          <p>
            –°–ª–µ–¥—É—è —ç—Ç–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º, –≤—ã —Å–º–æ–∂–µ—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∏
            –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
          </p>
        </div>
      </div>

      <!-- Messages -->
      <div class="flex-1 p-4 space-y-4">
        <div
          v-for="(msg, idx) in messages"
          :key="idx"
          class="flex"
          :class="msg.role === 'user' ? 'justify-end' : 'justify-start'"
        >
          <q-chat-message
            v-if="msg.role !== 'system'"
            :name="msg.role === 'user' ? props.name : 'Paida AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'"
            :sent="msg.role === 'user'"
            class="max-w-[70%]"
            bg-color="grey-3"
            text-color="black"
          >
            <div v-html="parseMarkdown(msg.content)" />
          </q-chat-message>
        </div>

        <!-- Thinking Steps -->
        <div v-if="props.loading && props.thinkingSteps.length" class="flex flex-col gap-2 mt-2">
          <div
            v-for="(step, i) in props.thinkingSteps"
            :key="i"
            v-show="i <= props.currentStepIndex"
            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl shadow-sm animate-fadeIn"
          >
            {{ step }}
          </div>
        </div>

        <!-- Fallback: –ø–µ—á–∞—Ç–∞–µ—Ç -->
        <div v-else-if="props.loading" class="flex justify-start mt-2">
        <div class="bg-gray-200 italic text-gray-600 px-4 py-2 rounded-xl flex items-center gap-1">
  <span>Paida —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç</span>
  <span class="dots">
    <span>.</span><span>.</span><span>.</span>
  </span>
</div>
        </div>
      </div>

      <!-- Input -->
      <div v-if="props.isVisibleChatID" class="sticky bottom-0 bg-gray-50 border-t p-4 z-10">
        <div class="flex gap-2">
          <Input
            dense
            outlined
            rounded
            :model-value="input"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"
            class="flex-1"
            @update:model-value="input = $event"
            @keyup.enter="sendMessage"
          />
          <Button round color="red" icon="mdi-delete" @click="deleteChat" />
          <Button
            round
            color="black"
            icon="send"
            @click="sendMessage"
            :disable="props.loading || !input.trim()"
          />
        </div>

        <!-- Suggestions -->
        <div v-if="!input.trim() && suggestions.length" class="mt-2 border rounded bg-white">
          <div
            v-for="(s, i) in suggestions"
            :key="i"
            class="p-2 hover:bg-gray-100 cursor-pointer flex gap-2"
            @click="selectSuggestion(s)"
          >
            <q-icon name="search" size="16px" />
            {{ s }}
          </div>
        </div>
      </div>
    </div>
  </main>
</template>

<script setup>
import { marked } from 'marked'
import { Button, Input } from 'src/components/atoms'
import { ref, watch } from 'vue'

const props = defineProps({
  isSystem: Boolean,
  isVisibleChatID: Boolean,
  messages: Object,
  loading: Boolean,
  thinkingSteps: Array,
  name: String,
  currentStepIndex: Number,
})
const input = ref('')
watch(
  () => props.isSystem,
  (newVal) => {
    console.log(newVal)
  },
)

const parseMarkdown = (text) => (text ? marked(text) : '')

const suggestions = ref([
  '–°–¥–µ–ª–∞–π –æ—Ç—á–µ—Ç –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∞–º (–¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)',
  '–°–∫–æ–ª—å–∫–æ —è –∑–∞—Ä–∞–±–æ—Ç–∞–ª –∑–∞ –º–µ—Å—è—Ü?',
  '–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —É –º–µ–Ω—è –∑–∞ –º–µ—Å—è—Ü?',
  '–ü–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π',
  '–ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∂–∏–ª—å–µ?',
  '–ö–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –Ω–æ–≤–∏—á–∫–∞?',
])

function selectSuggestion(s) {
  input.value = s
}

const emit = defineEmits(['sendMessage', 'deleteChat'])

const sendMessage = () => {
  emit('sendMessage', input.value)
  input.value = ''
}

const deleteChat = () => {
  emit('deleteChat')
}
</script>

<style scoped>
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.4s ease-out;
}

.dots span {
  animation: blink 1.4s infinite;
  opacity: 0;
}

.dots span:nth-child(1) { animation-delay: 0s; }
.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 20% { opacity: 0; }
  50%, 100% { opacity: 1; }
}
</style>
